# SmartFactory - YOLOv5

## 요약
- 아두이노(스마트팩토리)에서 레일에 물체를 올려두면 적외선 센서가 물체를 감지 후 물체를 판별하는 카메라 앞으로 이동시킨다. 그 후 카메라에서 데이터를 서버 컴퓨터(노트북)으로 전송하여 서버 컴퓨터(노트북)에서 YOLOv5를 통해 물체를 판별한다. 그 후 결과값을 블루투스를 통해 아두이노로 전송하여 분류기(모터)의 각도를 조절해 물체를 분류한다.



## 1. 아두이노

- 스마트 팩토리 키트를 이용하여 아두이노와 하드웨어를 제작
- 레일이 무한으로 돌면서 레일의 시작부분에서 적외선 센서를 통해 물체를 감지할 경우 레일이 1초간 멈췄다가 다시 움직여 카메라에 있는 지점까지 레일이 작동
  10초간 레일이 멈추고 카메라(서버연결)에서 물체를 탐지하여, 서버 컴퓨터에서       물체의 종류를 파악하고 블루투스 통신을 통해 아두이노로 데이터를 전송하여, 
  아두이노에서 분류기의 각도를 정해 원하는 지점으로 물체를 보낼 수 있게 함
  ( 10초안에 인식이 되면 10초를 기다리지 않고 바로 분류 / 10초안에 인식이
  물체를 다시 처음 지점으로 돌려보냄 )

[!] 스마트 팩토리 키드의 아두이노를 코드를 사용하지 않음 
![image](https://github.com/mcw1217/smartFactory_yolo/assets/87608623/bdd88c8a-7684-4d46-9cd4-19376e2888e6)



## 2. YOLOv5

- YOLOv5를 통해 초록색 블록, 회색 부품, 테이프 3가지를 학습시켰다.
- 데이터셋은 직접 수집한 사진 데이터를 roboflow 사이트에서 라벨링하여 구축

 ![image](https://github.com/mcw1217/smartFactory_yolo/assets/87608623/53278d04-7468-466b-aa88-e6753cc35e15)
![image](https://github.com/mcw1217/smartFactory_yolo/assets/87608623/4333274f-d797-49d5-8caf-18ae2d7d5f21)
![image](https://github.com/mcw1217/smartFactory_yolo/assets/87608623/f467626e-3db8-4a9c-8858-e7576b90f376)



|        Name      |   Train   |   Validation   |   Test   | 
|-------------------|---------------|----------------|---------------------|
| 초록 블럭     | 126 | 36 | 18 |
| 회색 부품     | 99 | 28 | 17 | 
| 테이프     | 84 | 24 | 12 |



### Detection 결과
__회색부품, 테이프, 초록 블록 순으로 정확도가 높았다.__
  회색 부품과 테이프의 경우 모양이 일정하다 그렇기에 카메라의 각도가 학습에
  학습에 사용된 위에서 찍는 구도가 나온다면, 매우 높은 정확도를 낼 수 있다. 
  하지만 학습량이 절대적으로 부족하기 때문에 학습하지 않은 옆부분이나 거리가
  멀어진다면 정확도가 현저히 떨어지게 된다. 이 부분은 추가적인 학습을 통해서
  개선이 가능하다. 초록 부품의 경우 학습량이 위 3가지 부품 중 가장 많지만 
  가장 낮은 정확도를 보였다. 그 이유로 1. 학습량이 절대적으로 부족하다. 3가지 
  물체 중에서는 가장 많은 양을 학습시켰지만, 최소한 수백개의 데이터셋이 필요
  하다. 2. 물체의 크기가 매우 작고, 특징이 부족하다. 해당 물체는 특징이라 할 
  부분이 거의 없고 물체가 작아 화질이 좋지 않은 카메라에서는 포커싱이 잘 
  잡히지 않기 때문에 Detection에 문제가 있다. 3. 물체의 모양이 일정하지 않다.
  물체의 모양이 원하는 방향으로 두게 되면 그에 따라 모양이 바뀐다. 즉 
  

![image](https://github.com/mcw1217/smartFactory_yolo/assets/87608623/ffe0526a-f61d-459b-820e-4e1374bb3438)
![image](https://github.com/mcw1217/smartFactory_yolo/assets/87608623/17e64d9d-1db4-48f7-866b-75e4d73ec3bb)

[ 1번 사진 ] [ 2번 사진 ]  <br>

위 사진과 같이 물체를 두는 방향에 따라 모두 학습을 시켜줘야 한다. 그렇지 않으면 정확도가 현저히 떨어지게 된다. YOLOv5의 detect 방식은 boxing 형식으로 가변적인 boxing이 불가능하다. 그렇기 때문에 학습을 시킬 때 배경이 포함된 채로 학습이 될텐데, 배경없이 완벽하게 물체만을 Labeling을 하였다면, detect 시 정확하게 boxing 안에 들어가는 방향으로 물체를 두어야만 인식이 된다. 그렇기 때문에 2번 사진과 같이 물체의 방향이 사선으로 있다면 반드시 배경을 포함해서 detection을 하기 때문에 낮은 정확도를 낼 수 밖에없다. 이를 해결하기 위해서는 학습 시 모든 변수의 방향 데이터를 수집하여 학습시킨다면 높은 정확도를 낼 수 있다. 

## 3. 아두이노와 서버 컴퓨터간의 블루투스 통신

- 아두이노와 서버 컴퓨터간의 블루투스를 연결하고 Serial 통신을 통하여 서버 컴퓨터에서 계산된 결과를 아두이노로 보내 아두이노를 동작시킨다.  

## 4. 낮은 정확도에 대한 개선

원인 1 – [ 학습 데이터의 부족 ]
해결책: 물체의 다양한 방향에 대한 데이터를 수집하여 학습을 시킨다면 정확도를 높일 수 있다. 데이터 수집시 배경 데이터가 최대한 포함되지 않게 학습을 진행하는 것이 정확도를 올리는데 좋다. 

원인 2 - [ 낮은 화질의 카메라 ]
해결책: 저품질 카메라의 경우 화질이 좋지 않아 데이터 학습에 사용된 사진의 화질과 비교될 수 있다. 특히 작은 물체의 경우 저품질 카메라에서 물체에 대한 포커싱을 잡지 못하기에 더더욱 정확도를 떨어뜨린다. 이 같은 경우 카메라를 교체하면되지만, 카메라를 새로 구매하기에는 많은 비용이든다. 그렇기에 누구나 가지고 있는 핸드폰을 사용하여, 저품질 카메라를 대신 할 것이다.
핸드폰 카메라의 화질은 일반적인 저품질 웹 카메라보다 높은 품질을 보장한다. 
컴퓨터와 핸드폰에 ivcam 프로그램을 설치한다. ivcam은 같은 대역의 통신연결이 될 경우 핸드폰 카메라 데이터를 연결된 컴퓨터로 전송한다. 이 방식을 사용한다면 웬만한 웹 카메라보다 좋은 품질을 보장받을 수 있다. 같은 대역은 wifi나 핸드폰의 핫스팟을 통하여 연결이 가능하다. 


## 5. 사용법

1. 아두이노 스마트팩토리 키트를 통해 하드웨어를 제작한 후 'bluetooth_module/SmartFactory_last' Directory에서 SmartFactory_last.ino 를 아두이노에 컴파일하여 업로드한다. 

2. 서버컴퓨터(노트북)에 웹캠 또는 위에서 제시한 ivcam을 방식 중 택 1을 하여 카메라를 연결한 후 'main_system(yolo)' Directory에서 main_system.py를 실행시켜 메인 시스템을 구축한다. (main_system.py에서 카메라 포트에 맞게 cv2.VideoCapture(수정) 수정부분을 변경한다. )


## Modify

원인 1. Detection 도중 물체에 대한 Confidence Size 만큼 Detection이 이뤄지지 않고 물체를 Deny 시키면 Confidence Size에 남아있는 Detection 데이터가 다음 물체를 Detect할때 남아있게 돼 문제가 발생

해결 1. main_system.py에 물체가 감지된 상태에서 3번의 프레임동안 Detection이 이뤄지지 않으면 자동으로 Confidence Size를 비움  


## 주소 
● 아두이노 – 스마트팩토리 키트
http://gileduzon.com/goods/goods_view.php?goodsNo=1000028344&inflow=naver&NaPm=ct%3Dlhx5xwz4%7Cci%3D03dfb349e0a8b52a3a3c4020bc238c7cc20f8c68%7Ctr%3Dslsl%7Csn%3D6532544%7Chk%3D40d22f608b46549a64d45d57b776528339b112b2

● 스마트팩토리 코드(아두이노)
https://github.com/mcw1217/smartFactory_yolo

● YOLOv5 학습 데이터 셋
https://app.roboflow.com/school-blwzo/smartfactorydetection/deploy/1



